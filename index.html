<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>
    
</style>

<body>
    <div class="main">
        <div>
            <form id="formEntrar">
                <input type="text" name="name" id="name" placeholder="Insira seu nome">
                <button id="btnEntrar">Entrar</button>
            </form>
        </div>
        <div id="chatArea" class="chat-area blocked">
            <div id="messages" class="messages">
                <!-- <div class="me">
                    <span class="author">gustavo</span>
                    <span class="text">mensagem minha</span>
                </div>
                <span class="other">mensagem de outra pessoa</span> -->
            </div>
            <input type="text" name="message" id="inputMessage">
        </div>
    </div>

    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"
        integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
        crossorigin="anonymous"></script>

    <script>
        const URL_API = 'http://localhost:3000'
        const socket = io(URL_API);

        socket.on('connect', function () {
            console.log('client connected');
        });

        const nameInput = document.querySelector('#name');
        const btnEntrar = document.querySelector('#btnEntrar');
        const formEntrar = document.querySelector('#formEntrar');
        const chatArea = document.querySelector('#chatArea');
        const messages = document.querySelector('#messages');
        const inputMessage = document.querySelector('#inputMessage');

        const headerDefault = { 'Content-type': 'application/json' };

        formEntrar.addEventListener('submit', (event) => {
            event.preventDefault();
            entrar();
        })

        inputMessage.addEventListener('keyup', (event) => {
            var key = event.which || event.keyCode;
            const enterKeyCode = 13;

            if (key == enterKeyCode) {
                sendMessage(inputMessage.value);
            }
        })

        function entrar() {
            fetch(`${URL_API}/entrar`, {
                method: 'POST', headers: headerDefault, body: JSON.stringify({
                    name: nameInput.value,
                    socketId: socket.id
                })
            })
                .then(() => {
                    nameInput.disabled = true;
                    btnEntrar.style = 'display: none';
                })
                .catch(err => {
                    alert(err);
                });
        }

        function sendMessage(text) {
            fetch(`${URL_API}/message`, {
                method: 'POST', headers: headerDefault, body: JSON.stringify({
                    text, username: nameInput.value
                })
            }).catch(err => {
                alert(err);
            });
        }

        function getMessages() {
            fetch(`${URL_API}/message`, {
                method: 'GET', headers: headerDefault
            })
                .then((response) => response.json())
                .then((messages) => {
                    for (const message of messages) {
                        console.log(message);
                        addNewMessage(message);
                    }
                })
                .catch(err => {
                    alert(err);
                });
        }

        function addNewMessage(message) {
            const { text, user } = message;

            const itsMe = user.name == nameInput.value;

            const newMessage = document.createElement('span');
            newMessage.classList.add(itsMe ? 'me' : 'other');
            newMessage.innerHTML = `
            <span class="author">${user.name}</span>
            <span class="text">${text}</span>
            `;

            messages.appendChild(newMessage);

            inputMessage.value = '';
            messages.scrollTop = messages.scrollHeight;
        }

        socket.on('enter-chat', (user) => {
            
            if (user.socketId == socket.id) {
                chatArea.classList.remove('blocked');
                getMessages();
            }

            inputMessage.focus();
        });

        socket.on('leave-chat', () => {
            chatArea.classList.add('blocked');
        });

        socket.on('message', (message) => {
            console.log('message', message);
            addNewMessage(message);
        })


    </script>
</body>

</html>